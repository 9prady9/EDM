build-windows:
  stage: build
  script:
    - cmake -B build -S .
    - cmake --build build --config release
    - cmake --build build --config release --target install
  artifacts:
    paths:
    - stata/edm_Windows_x64.plugin
  tags:
    - windows-runner

test-windows:
  stage: test
  dependencies:
    - build-windows
  before_script:
    - cd stata
    - rename cut-down-test.log reference.log
  script:
    - \"C:\\Program Files\\Stata16\\StataMP-64.exe\" -e -q cut-down-test.do
    - fc /W reference.log cut-down-test.log
  tags:
    - windows-runner

build-mac:
  stage: build
  before_script:
    - export VCPKG_ROOT=~/vcpkg/
    - export PATH="/Users/user175910/bin:$PATH"
  script:
    - cmake -B build -S .
    - cmake --build build --config release
    - cmake --build build --config release --target install
  artifacts:
    paths:
      - stata/edm_MacOSX_x64.plugin
  tags:
    - mac-runner

test-mac:
  stage: test
  dependencies:
    - build-mac
  before_script:
    - cd stata
    - mv cut-down-test.log reference.log
  script:
    - ~/Stata/StataMP.app/Contents/MacOS/StataMP -e -q cut-down-test.do
    - diff -B reference.log cut-down-test.log
  tags:
    - mac-runner

build-ubuntu:
  stage: build
  before_script:
    - export VCPKG_ROOT=~/vcpkg/
  script:
    - mkdir build
    - cd build
    - cmake ..
    - cd ..
    - cmake --build build --config release
    - cmake --build build --config release --target install
  artifacts:
    paths:
      - stata/edm_Unix_x64.plugin
  tags:
    - ubuntu-stata-runner

test-ubuntu:
  stage: test
  dependencies:
    - build-ubuntu
  before_script:
    - cd stata
    - mv cut-down-test.log reference.log
  script:
    - stata -e -q cut-down-test.do
    - diff -B reference.log cut-down-test.log
  tags:
    - ubuntu-stata-runner