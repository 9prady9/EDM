# Stata EDM C plugin

## Compilation on Windows

On Windows, one can either compile the plugin by using CMake or by creating a Visual Studio (VS) project and compiling using the GUI.

Prerequisites:

- [GSL](http://www.gnu.org/software/gsl/) (installed via [vcpkg](https://github.com/Microsoft/vcpkg) below)
- [Visual Studio](https://visualstudio.microsoft.com/)
- Cmake (optional)

Firstly, follow the [vcpkg Quick Start for Windows](https://github.com/Microsoft/vcpkg#quick-start-windows) to setup the package manager we'll use to install the GSL library. The current instructions for vckpg use [Git](https://git-scm.com/) and run the commands

```powershell
git clone https://github.com/microsoft/vcpkg
.\vcpkg\bootstrap-vcpkg.bat
```

If compiling for 64 bit then install GSL by running

```powershell
.\vcpkg\vcpkg install gsl:x64-windows-static
```

or for 32 bit use

```powershell
.\vcpkg\vcpkg install gsl:x64-windows-static
```

If you are plan to manually create a VS project to compile the plugin, also run

```powershell
.\vcpkg\vcpkg integrate install
```

so that VS projects automatically find vcpkg's installed packages as soon as they are `#include`'d.

Get the plugin source from [Github (TODO!)](https://github.com/...).  If using CMake, open a terminal and change directory into the plugin folder. If compiling for 64 bit run

```powershell
cmake -B build -S . -DSYSTEM=STWIN32 -DCMAKE_TOOLCHAIN_FILE=[path to vcpkg]\scripts\buildsystems\vcpkg.cmake -DVCPKG_TARGET_TRIPLET=x64-windows-static
cmake --build build --config Release
cp .\build\Release\smap_block_mdap.plugin .\stata\
```

To target 32 bit systems, simply replace the last flag's value `x64-windows-static` with `x86-windows-static` on the first line. These commands: (i) create a 'build' subdirectory to hold the build files and fills it with autogenerated VS solution files, (ii) compile the plugin, and (iii) copies the compiled 'smap_block_mdap.plugin' file to the stata directory.

Building with CMake is optional, one can directly create a VS solution to build the plugin. The following instructions are mostly a copy from the [Stata plugin documentation](https://www.stata.com/plugins/#sect5a), though Step 6 here is added to ensure that there are no runtime dependencies. Open VS and:   

1. Select **File** > **New** > **Project**.
2. Select **Windows Desktop Wizard**. Next, give the project a name like **edm**.
3. In the **Windows Destkop Project Wizard**, for **Application type** select **Dynamic Link Library (.dll)**. You should select **Empty project** to open a project with no existing files.
4. Next, under the **Solution Explorer**, right-click on **Source files**, and select **Add** > **Existing Items**.
5. Add the files **[stplugin.h](https://www.stata.com/plugins/stplugin.h)**, **[stplugin.c](https://www.stata.com/plugins/stplugin.c)**, and **[smap_block_mdap.c (TODO!)](https://github.com/...)**.
6. Open the project's properties page by choosing **Project** > **edm Properties** from the main menu, make sure that **Configuration** is set to **All Configurations**, then go to **Configuration Properties > Vcpkg** and set "Use static libraries" to Yes.
7. Build the DLL by selecting **Build** > **Build edm** (for 64-bit DLL/Stata select **x64** for the Solution Platform). If all goes well (it should), you will now find the file **edm.dll** within the **x64/Debug** subdirectory of your project directory.
8. Rename **edm.dll** to **edm-Windows-64.plugin** (or **edm-Windows-32.plugin**).
