# Stata EDM C plugin

## Compilation on Windows

On Windows, one can either compile the plugin by using CMake or by creating a Visual Studio (VS) project and compiling using the GUI.

Prerequisites:

- [GSL](http://www.gnu.org/software/gsl/) (installed via [vcpkg](https://github.com/Microsoft/vcpkg) below)
- [Visual Studio](https://visualstudio.microsoft.com/)
- Cmake (optional)

Firstly, follow the [vcpkg Quick Start for Windows](https://github.com/Microsoft/vcpkg#quick-start-windows) to setup the package manager we'll use to install the GSL library. The current instructions for vckpg use [Git](https://git-scm.com/) and run the commands

```powershell
> git clone https://github.com/microsoft/vcpkg
> .\vcpkg\bootstrap-vcpkg.bat
> .\vcpkg\vcpkg install gsl gsl:x64-windows
```

This will install both the 32 and 64 bit versions of GSL. If you are plan to manually create a VS project to compile the plugin, also run

```powershell
> .\vcpkg\vcpkg integrate install
```

so that VS projects automatically find vcpkg's installed packages as soon as they are `#include`'d.

Get the plugin source from [Github (TODO!)](https://github.com/...).  If using CMake, open a terminal and change directory into the plugin folder. Run

```powershell
> cmake -B build -S . -DCMAKE_TOOLCHAIN_FILE=[path to vcpkg]\scripts\buildsystems\vcpkg.cmake -DSYSTEM=STWIN32
> cmake --build build --config Release
> cp .\build\Release\smap_block_mdap.* .\stata\
```

These commands: (i) create a 'build' subdirectory to hold the build files and fills it with autogenerated VS solution files, (ii) compile the plugin, and (iii) move the compiled 'smap_block_mdap.plugin' file to the stata directory.

Finally, copy the "gsl.dll" and "gslcblas.dll" files from their vcpkg installed location to the stata folder. E.g. if compiling for 32 bit Windows run

```powershell
> cp [path to vcpkg]\installed\x86-windows\bin\gsl.dll .\stata
> cp [path to vcpkg]\installed\x86-windows\bin\gslcblas.dll .\stata
```

or if compiling for 64 bit

```powershell
> cp [path to vcpkg]\installed\x64-windows\bin\gsl.dll .\stata
> cp [path to vcpkg]\installed\x64-windows\bin\gslcblas.dll .\stata
```

If you're not using CMake but are directly creating the VS solution to build the plugin, you open VS and use the [Stata plugin documentation](https://www.stata.com/plugins/#sect5a) steps for compiling in Windows, which are copied below.

1. **File** > **New** > **Project**.
2. Select **Windows Desktop Wizard**. Next, give the project a name (**edm**, for instance).
3. In the **Windows Destkop Project Wizard**, for **Application type** select **Dynamic Link Library (.dll)**. You should select **Empty project** to open a project with no existing files.
4. Next, under the **Solution Explorer**, right-click on **Source files**, and select **Add** > **Existing Items**.
5. Add the files **[stplugin.h](https://www.stata.com/plugins/stplugin.h)**, **[stplugin.c](https://www.stata.com/plugins/stplugin.c)**, and **[smap_block_mdap.c (TODO!)](https://github.com/...)**.
6. Build the DLL by selecting **Build** > **Build edm** (for 64-bit DLL/Stata select **x64** for the Solution Platform). If all goes well (it should), you will now find the file **edm.dll** within the **x64/Debug** subdirectory of your project directory.
7. You may rename **edm.dll** to **edm.plugin**. This will save you from having to specify the **using()** option when you load your plugin, but this is not required.

