

. clear

. 
. set linesize 255

. set obs 500
Number of observations (_N) was 0, now 500.

. set seed 12345678

. if c(MP) {
.     qui set processor 1
. }

. 
. global EDM_VERBOSITY=1

. global EDM_NTHREADS=4

. 
. gen t = _n

. tsset t

Time variable: t, 1 to 500
        Delta: 1 unit

. 
. gen double x = 0.2 if _n==1
(499 missing values generated)

. gen double y = 0.4 if _n==1
(499 missing values generated)

. 
. * Create a dynamic system
. local r_x 3.625

. local r_y 3.77

. local beta_xy = 0.05

. local beta_yx=0.4

. local tau = 1

. drawnorm double u1 u2

. qui {

. 
. * burn the first 300 observations
. keep in 300/500
(299 observations deleted)

. 
. * Determining the complexity of the system
. 
. * identify optimal E
. edm explore x, e(2/10)
Percent complete: 0...10...20...30...40...50...60...70...80...90...

Empirical Dynamic Modelling
Univariate mapping with x and its lag values
--------------------------------------------------------------------
          Actual E           theta             rho             MAE
--------------------------------------------------------------------
                 2               1          .99838         .008126 
                 3               1          .99777          .01015 
                 4               1          .99726         .011441 
                 5               1          .99707         .012625 
                 6               1          .99397          .01607 
                 7               1          .99222         .018344 
                 8               1          .98998         .021055 
                 9               1          .98896         .022099 
                10               1          .98566          .02446 
--------------------------------------------------------------------
Note: Number of neighbours (k) is set to E+1
Note: Random 50/50 split for training and validation data

. 
. * edm xmap x y, k(5)
. 
. * edm xmap x y, e(6) lib(8)
. 
. edm explore x, k(5) crossfold(10)
10-fold cross-validation progress (10 in total)
Percent complete: 0...10...20...30...40...50...60...70...80...90...

Empirical Dynamic Modelling
Univariate mapping with x and its lag values
----------------------------------------------------------------------
                      --------- rho ---------  --------- MAE ---------
 Actual E    theta         Mean    Std. Dev.         Mean    Std. Dev.
----------------------------------------------------------------------
        2        1        .9994    .00037366     .0049774    .00084076
----------------------------------------------------------------------
Note: Results from 10 runs
Note: Number of neighbours (k) is adjusted to 5
Note: 10-fold cross validation results reported

. 
. edm explore x, theta(0.2(0.1)2.0) algorithm(smap)
Percent complete: 0..
Empirical Dynamic Modelling
Univariate mapping with x and its lag values
--------------------------------------------------------------------
          Actual E           theta             rho             MAE
--------------------------------------------------------------------
                 2              .2          .99959        .0036474 
                 2              .3           .9996        .0036208 
                 2              .4          .99961        .0035963 
                 2              .5          .99961        .0035715 
                 2              .6          .99962        .0035465 
                 2              .7          .99962        .0035213 
                 2              .8          .99963        .0034964 
                 2              .9          .99964        .0034721 
                 2               1          .99964         .003449 
                 2             1.1          .99965        .0034272 
                 2             1.2          .99965        .0034084 
                 2             1.3          .99966        .0033928 
                 2             1.4          .99966        .0033796 
                 2             1.5          .99967        .0033655 
                 2             1.6          .99967        .0033503 
                 2             1.7          .99967         .003334 
                 2             1.8          .99968        .0033169 
                 2             1.9          .99968        .0032997 
                 2               2          .99968        .0032823 
--------------------------------------------------------------------
Note: Number of neighbours (k) is set to E+2
Note: Random 50/50 split for training and validation data

. 
. * edm xmap x y, theta(0.2) algorithm(smap) savesmap(beta)
. * assert beta1_b2_rep1 !=. if _n>1
. 
. * edm xmap y x, predict(x2) direction(oneway)
. * assert x2 !=. if _n>1
. 
. edm explore x, copredict(teste) copredictvar(y)
Percent complete: 0...10...20...30...40...50...60...70...80...90...
Percent complete: 0...10...20...30...40...50...60...70...80...90...

Empirical Dynamic Modelling
Univariate mapping with x and its lag values
--------------------------------------------------------------------
          Actual E           theta             rho             MAE
--------------------------------------------------------------------
                 2               1          .99911        .0059669 
--------------------------------------------------------------------
Note: Number of neighbours (k) is set to E+1
Note: Random 50/50 split for training and validation data

. assert teste!=. if _n>1

. 
. edm explore z.x, tp(10)
Percent complete: 0...10...20...30...40...50...60...70...80...90...

Empirical Dynamic Modelling
Univariate mapping with z.x and its lag values
--------------------------------------------------------------------
          Actual E           theta             rho             MAE
--------------------------------------------------------------------
                 2               1          .91672          .30616 
--------------------------------------------------------------------
Note: Number of neighbours (k) is set to E+1
Note: Random 50/50 split for training and validation data

. 
. * edm xmap y x, tp(10) direction(oneway)
. 
. * edm xmap y x, tp(10) copredict(testx) copredictvar(x2 y) direction(oneway)
. * assert testx!=. if _n>2
. 
. * edm xmap y x, tp(10) copredict(testx2) copredictvar(z.x2 z.y) direction(oneway)
. * assert testx2 !=. if _n>2
. 
. * edm xmap y x, extra(u1) tp(10) copredict(testx3) copredictvar(z.x2 z.y) direction(oneway)
. * assert testx3 !=. if _n>2
. 
. * check explore / xmap consistency
. 
. * edm xmap l.x x, direction(oneway)
. * mat xmap_r=e(b)
. edm explore x, full
Percent complete: 0...10...20...30...40...50...60...70...80...90...

Empirical Dynamic Modelling
Univariate mapping with x and its lag values
--------------------------------------------------------------------
          Actual E           theta             rho             MAE
--------------------------------------------------------------------
                 2               1          .99939        .0049147 
--------------------------------------------------------------------
Note: Number of neighbours (k) is set to E+1
Note: Full sample used for the computation

. mat explore_r =e(b)

. * assert xmap_r[1,1] == explore_r[1,1]
. 
. * check xmap reverse consistency
. 
. * edm xmap x y
. * mat xmap1 = e(b)
. * edm xmap y x
. * TODO: Fix the following asserts, which are considered syntax errors in Stata15 (on Mac).
. * assert e(b)[1,1] == xmap1[1,2]
. * assert e(b)[1,2] == xmap1[1,1]
. 
. tempfile basedata

. qui compress

. qui save `basedata', replace

. * test missing data
. set seed 12345678

. gen double u = runiform()

. drop if u<0.1
(19 observations deleted)

. replace x = . if u<0.2
(22 real changes made, 22 to missing)

. replace t=. if mod(t,19) ==1
(11 real changes made, 11 to missing)

. 
. edm explore x
Percent complete: 0...10...20...30...40...50...60...70...80...90...

Empirical Dynamic Modelling
Univariate mapping with x and its lag values
--------------------------------------------------------------------
          Actual E           theta             rho             MAE
--------------------------------------------------------------------
                 2               1          .99627          .01523 
--------------------------------------------------------------------
Note: Number of neighbours (k) is set to E+1
Note: Random 50/50 split for training and validation data

. edm explore x, dt
Percent complete: 0...10...20...30...40...50...60...70...80...90...

Empirical Dynamic Modelling
Multivariate mapping with x and its lag values
Additional variables in the embedding: (time delta)
--------------------------------------------------------------------
          Actual E           theta             rho             MAE
--------------------------------------------------------------------
                 3               1          .58186          .13183 
--------------------------------------------------------------------
Note: Actual E is higher than the specified E due to extras
Note: Number of neighbours (k) is set to E+2
Note: Random 50/50 split for training and validation data
Note: Embedding includes the delta of the time variable with a weight of .36

. 
. edm explore x, allowmissing
Percent complete: 0...10...20...30...40...50...60...70...80...90...

Empirical Dynamic Modelling
Univariate mapping with x and its lag values
Missing values are assumed to have a distance of .24 with all values.
--------------------------------------------------------------------
          Actual E           theta             rho             MAE
--------------------------------------------------------------------
                 2               1          .99682         .011803 
--------------------------------------------------------------------
Note: Number of neighbours (k) is set to E+1
Note: Random 50/50 split for training and validation data

. edm explore x, missingdistance(2)
Percent complete: 0...10...20...30...40...50...60...70...80...90...

Empirical Dynamic Modelling
Univariate mapping with x and its lag values
Missing values are assumed to have a distance of 2 with all values.
--------------------------------------------------------------------
          Actual E           theta             rho             MAE
--------------------------------------------------------------------
                 2               1          .99531          .01599 
--------------------------------------------------------------------
Note: Number of neighbours (k) is set to E+1
Note: Random 50/50 split for training and validation data

. * edm xmap x l.x, allowmissing
. * edm xmap x l.x, missingdistance(2)
. 
. * edm xmap x l.x, extraembed(u) allowmissing dt alg(smap) savesmap(newb) e(5)
. 
. * edm xmap x l3.x, extraembed(u) allowmissing dt alg(smap) savesmap(newc) e(5) oneway dtsave(testdt)
. 
. edm explore x, extraembed(u) allowmissing dt crossfold(5)
5-fold cross-validation progress (5 in total)
Percent complete: 0...10...20...30...40...50...60...70...80...90...

Empirical Dynamic Modelling
Multivariate mapping with x and its lag values
Additional variables in the embedding: u (+ time delta)
Missing values are assumed to have a distance of .25 with all values.
----------------------------------------------------------------------
                      --------- rho ---------  --------- MAE ---------
 Actual E    theta         Mean    Std. Dev.         Mean    Std. Dev.
----------------------------------------------------------------------
        4        1       .59097       .15207       .12651      .021386
----------------------------------------------------------------------
Note: Results from 5 runs
Note: Actual E is higher than the specified E due to extras
Note: Number of neighbours (k) is set to E+3
Note: 5-fold cross validation results reported
Note: Embedding includes the delta of the time variable with a weight of .55

. 
. edm explore d.x, dt
Percent complete: 0...10...20...30...40...50...60...70...80...90...

Empirical Dynamic Modelling
Multivariate mapping with d.x and its lag values
Additional variables in the embedding: (time delta)
--------------------------------------------------------------------
          Actual E           theta             rho             MAE
--------------------------------------------------------------------
                 3               1          .84472          .14535 
--------------------------------------------------------------------
Note: Actual E is higher than the specified E due to extras
Note: Number of neighbours (k) is set to E+2
Note: Random 50/50 split for training and validation data
Note: Embedding includes the delta of the time variable with a weight of .27

. 
. edm explore x, rep(20) ci(95)
Replication progress (20 in total)
Percent complete: 0...10...20...30...40...50...60...70...80...90...

Empirical Dynamic Modelling
Univariate mapping with x and its lag values
----------------------------------------------------------------------
                      --------- rho ---------  --------- MAE ---------
 Actual E    theta         Mean    Std. Dev.         Mean    Std. Dev.
----------------------------------------------------------------------
        2        1       .99567     .0042336      .013306     .0036066
  Est. mean 95% CI   [   .99369,    .99765 ]   [  .011618,   .014994 ]
2.5/97.5 Pc (Est.)   [   .98737,     1.004 ]   [ .0062374,   .020375 ]
2.5/97.5 Pc (Obs.)   [    .9835,    .99822 ]   [ .0098926,    .02064 ]
----------------------------------------------------------------------
Note: Results from 20 runs
Note: Number of neighbours (k) is set to E+1
Note: Random 50/50 split for training and validation data

. 
. * edm xmap x y, lib(50) rep(20) ci(95)
. 
. use `basedata', clear

. cap drop x_copy

. cap drop x_p

. cap drop xc_p

. clonevar x_copy = x

. edm explore x, predict(x_p) copredict(xc_p) copredictvar(x_copy) full
Percent complete: 0...10...20...30...40...50...60...70...80...90...
Percent complete: 0...10...20...30...40...50...60...70...80...90...

Empirical Dynamic Modelling
Univariate mapping with x and its lag values
--------------------------------------------------------------------
          Actual E           theta             rho             MAE
--------------------------------------------------------------------
                 2               1          .99939        .0049147 
--------------------------------------------------------------------
Note: Number of neighbours (k) is set to E+1
Note: Full sample used for the computation

. assert x_p!=. if _n!=1 & _n!=_N

. assert xc_p!=. if _n!=1 & _n!=_N

. assert x_p ==xc_p if x_p!=.

. cor x_p f.x
(obs=199)

             |                 F.
             |      x_p        x
-------------+------------------
         x_p |   1.0000
           x |
         F1. |   0.9994   1.0000


. cor xc_p f.x
(obs=199)

             |                 F.
             |     xc_p        x
-------------+------------------
        xc_p |   1.0000
           x |
         F1. |   0.9994   1.0000


. 
. cap drop x_p xc_p

. edm explore x, predict(x_p) copredict(xc_p) copredictvar(x_copy) full tp(2)
Percent complete: 0...10...20...30...40...50...60...70...80...90...
Percent complete: 0...10...20...30...40...50...60...70...80...90...

Empirical Dynamic Modelling
Univariate mapping with x and its lag values
--------------------------------------------------------------------
          Actual E           theta             rho             MAE
--------------------------------------------------------------------
                 2               1          .99877        .0078776 
--------------------------------------------------------------------
Note: Number of neighbours (k) is set to E+1
Note: Full sample used for the computation

. sum x_p xc_p

    Variable |        Obs        Mean    Std. dev.       Min        Max
-------------+---------------------------------------------------------
         x_p |        198    .6434232    .2159587   .3039276   .8967989
        xc_p |        200    .6436226    .2154685   .3039276   .8967989

. assert xc_p!=. if x_p!=.

. 
. gen y_copy = y

. * edm xmap x y, tp(10) copredict(xmap_y_p) copredictvar(x_copy y_copy) direction(oneway) predict(xmap_y)
. * assert xmap_y_p !=. if _n>1
. * assert xmap_y_p == xmap_y if xmap_y !=.
. 
. preserve

. drop if mod(t,17)==1
(12 observations deleted)

. //copredict with dt
. * edm xmap x y, dt copredict(xmap_y_p_dt) copredictvar(x_copy y_copy) direction(oneway) predict(xmap_y_dt)
. * assert xmap_y_p_dt !=. if (_n>1 & _n < _N)
. * assert xmap_y_p_dt == xmap_y_dt if xmap_y_dt !=. & xmap_y_p_dt != .
. 
. edm explore x, predict(predicted_x_dt) copredict(predicted_x_copy_dt) copredictvar(x_copy) full
Percent complete: 0...10...20...30...40...50...60...70...80...90...
Percent complete: 0...10...20...30...40...50...60...70...80...90...

Empirical Dynamic Modelling
Univariate mapping with x and its lag values
--------------------------------------------------------------------
          Actual E           theta             rho             MAE
--------------------------------------------------------------------
                 2               1          .99928        .0054303 
--------------------------------------------------------------------
Note: Number of neighbours (k) is set to E+1
Note: Full sample used for the computation

. 
. assert predicted_x_dt == predicted_x_copy_dt if predicted_x_dt!=.

. 
. restore

. 
. edm explore x, copredict(dx2) copredictvar(d.x)
Percent complete: 0...10...20...30...40...50...60...70...80...90...
Percent complete: 0...10...20...30...40...50...60...70...80...90...

Empirical Dynamic Modelling
Univariate mapping with x and its lag values
--------------------------------------------------------------------
          Actual E           theta             rho             MAE
--------------------------------------------------------------------
                 2               1          .99105         .011687 
--------------------------------------------------------------------
Note: Number of neighbours (k) is set to E+1
Note: Random 50/50 split for training and validation data

. 
. edm explore x, predict(predicted_x) copredict(predicted_y_from_mx) copredictvar(y) full
Percent complete: 0...10...20...30...40...50...60...70...80...90...
Percent complete: 0...10...20...30...40...50...60...70...80...90...

Empirical Dynamic Modelling
Univariate mapping with x and its lag values
--------------------------------------------------------------------
          Actual E           theta             rho             MAE
--------------------------------------------------------------------
                 2               1          .99939        .0049147 
--------------------------------------------------------------------
Note: Number of neighbours (k) is set to E+1
Note: Full sample used for the computation

. edm explore y, predict(predicted_y) full
Percent complete: 0...10...20...30...40...50...60...70...80...90...

Empirical Dynamic Modelling
Univariate mapping with y and its lag values
--------------------------------------------------------------------
          Actual E           theta             rho             MAE
--------------------------------------------------------------------
                 2               1          .99279          .01359 
--------------------------------------------------------------------
Note: Number of neighbours (k) is set to E+1
Note: Full sample used for the computation

. cor f.x f.y predicted_x predicted_y predicted_y_from_mx
(obs=199)

             |        F.       F.                           
             |        x        y predi~_x predic~y predi~mx
-------------+---------------------------------------------
           x |
         F1. |   1.0000
           y |
         F1. |   0.3545   1.0000
 predicted_x |   0.9994   0.3467   1.0000
 predicted_y |   0.3618   0.9928   0.3540   1.0000
predicted~mx |   0.1334   0.7831   0.1217   0.7850   1.0000


. cor f.x predicted_x
(obs=199)

             |        F.         
             |        x predi~_x
-------------+------------------
           x |
         F1. |   1.0000
 predicted_x |   0.9994   1.0000


. assert r(rho)>0.99

. cor f.y predicted_y
(obs=199)

             |        F.         
             |        y predic~y
-------------+------------------
           y |
         F1. |   1.0000
 predicted_y |   0.9928   1.0000


. assert r(rho)>0.99

. cor f.y predicted_y_from_mx
(obs=199)

             |        F.         
             |        y predi~mx
-------------+------------------
           y |
         F1. |   1.0000
predicted~mx |   0.7831   1.0000


. assert r(rho)>0.7

. 
. * * Obtaining CI of the xmap
. * jackknife: edm xmap x y, e(2)
. * ereturn display
. 
. jackknife: edm explore x, e(2)
(running edm on estimation sample)

Jackknife replications (199)
----+--- 1 ---+--- 2 ---+--- 3 ---+--- 4 ---+--- 5 
..................................................    50
..................................................   100
..................................................   150
.................................................

Empirical Dynamic Modelling
Univariate mapping with x and its lag values
--------------------------------------------------------------------
          Actual E           theta             rho             MAE
--------------------------------------------------------------------
                 2               1          .99896         .007504 
--------------------------------------------------------------------
Note: Number of neighbours (k) is set to E+1
Note: Random 50/50 split for training and validation data

. ereturn display
------------------------------------------------------------------------------
             |              Jackknife
             | Coefficient  std. err.      t    P>|t|     [95% conf. interval]
-------------+----------------------------------------------------------------
           x |    .998957   .0130594    76.49   0.000     .9732036     1.02471
------------------------------------------------------------------------------

. 
end of do-file
